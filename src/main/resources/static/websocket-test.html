<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications de Commandes - Pâtisserie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-6">
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-white">
            <h1 class="text-2xl md:text-3xl font-bold">Notifications en temps réel</h1>
            <p class="text-blue-100">Suivi des nouvelles commandes</p>
        </div>

        <!-- Connection Panel -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-medium mb-1">ID Pâtisserie</label>
                    <input type="number" id="patisserieId" value="1"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex gap-2">
                    <button id="connectBtn" onclick="toggleConnection()"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                        <svg id="connectIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>
                        <span>Connecter</span>
                    </button>
                    <button onclick="clearNotifications()"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="connectionStatus" class="mt-3 text-sm text-gray-500 flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-gray-300"></div>
                <span>Non connecté</span>
            </div>
        </div>

        <!-- Notifications Container -->
        <div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Dernières commandes</h2>
                <span id="notificationCount" class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span>
            </div>

            <div id="notifications" class="space-y-3">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center text-gray-500">
                    Aucune notification reçue
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentSubscription = null;
    let notificationCounter = 0;
    const notificationsDiv = document.getElementById('notifications');
    const notificationCountSpan = document.getElementById('notificationCount');
    const connectionStatusDiv = document.getElementById('connectionStatus');

    function updateConnectionStatus(connected) {
        const statusDot = connectionStatusDiv.querySelector('div');
        const statusText = connectionStatusDiv.querySelector('span');

        if (connected) {
            statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
            statusText.textContent = `Connecté à /topic/patisserie/${document.getElementById('patisserieId').value}/nouvelles-commandes`;
            statusText.className = 'text-green-600';
        } else {
            statusDot.className = 'w-3 h-3 rounded-full bg-gray-300';
            statusText.textContent = 'Non connecté';
            statusText.className = 'text-gray-500';
        }
    }

    function connect() {
        const patisserieId = document.getElementById('patisserieId').value;

        // Déconnexion si déjà connecté
        if (stompClient !== null) {
            disconnect();
        }

        const socket = new SockJS('/ws-commandes');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            updateConnectionStatus(true);

            // Nouvel abonnement avec le nouvel ID
            currentSubscription = stompClient.subscribe(
                `/topic/patisserie/${patisserieId}/nouvelles-commandes`,
                function(message) {
                    const commande = JSON.parse(message.body);
                    addNotification(commande);
                }
            );

            // Mettre à jour le bouton
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg><span>Déconnecter</span>';
            btn.className = btn.className.replace('bg-blue-600', 'bg-red-600').replace('hover:bg-blue-700', 'hover:bg-red-700');
        }, function(error) {
            console.error('Connection error: ', error);
            updateConnectionStatus(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            if (currentSubscription !== null) {
                currentSubscription.unsubscribe();
                currentSubscription = null;
            }
            stompClient.disconnect();
            stompClient = null;

            updateConnectionStatus(false);

            // Mettre à jour le bouton
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg><span>Connecter</span>';
            btn.className = btn.className.replace('bg-red-600', 'bg-blue-600').replace('hover:bg-red-700', 'hover:bg-blue-700');
        }
    }

    function toggleConnection() {
        if (stompClient && stompClient.connected) {
            disconnect();
        } else {
            connect();
        }
    }

    function clearNotifications() {
        notificationsDiv.innerHTML = '<div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center text-gray-500">Aucune notification reçue</div>';
        notificationCounter = 0;
        notificationCountSpan.textContent = '0';
    }

    function addNotification(commande) {
        // Supprimer le message "Aucune notification" s'il existe
        if (notificationsDiv.children.length === 1 && notificationsDiv.children[0].textContent.includes("Aucune notification")) {
            notificationsDiv.innerHTML = '';
        }

        notificationCounter++;
        notificationCountSpan.textContent = notificationCounter;

        const notification = document.createElement('div');
        notification.className = 'fade-in p-4 bg-white rounded-lg shadow border border-gray-200 hover:shadow-md transition';
        notification.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h3 class="font-bold text-lg text-blue-600">Commande #${commande.id}</h3>
                    <p class="text-sm text-gray-500">${new Date(commande.dateCreation).toLocaleString()}</p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full
                    ${commande.statut === 'EN_ATTENTE' ? 'bg-yellow-100 text-yellow-800' :
                      commande.statut === 'EN_COURS' ? 'bg-blue-100 text-blue-800' :
                      'bg-green-100 text-green-800'}">
                    ${commande.statut.replace('_', ' ')}
                </span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-500">Montant Total</p>
                    <p class="font-bold text-xl text-blue-700">${commande.montantTotal} €</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-500">Nombre de Personnes</p>
                    <p class="font-bold text-xl text-blue-700">${commande.nombrePersonnes}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                <div>
                    <p class="text-sm text-gray-500">Pâtisserie</p>
                    <p class="font-medium">${commande.patisserieNom} (ID: ${commande.patisserieId})</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Téléphone Client</p>
                    <p class="font-medium">${commande.telephoneClient}</p>
                </div>
            </div>

            <div class="mb-3">
                <p class="text-sm text-gray-500">Glacage</p>
                <p class="font-medium">${commande.glacage || 'Non spécifié'}</p>
            </div>

            <div class="mb-1">
                <p class="text-sm text-gray-500">Détails des couches</p>
                <div class="mt-2 space-y-2">
                    ${commande.couches.map((couche, index) => `
                        <div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded">
                            <div>
                                <span class="font-medium">Couche ${index + 1}</span>
                                <span class="text-gray-500 text-sm ml-2">${couche.saveur}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-sm">${couche.epaisseur} cm</span>
                                <span class="ml-2 font-medium">${couche.prix} €</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        notificationsDiv.insertBefore(notification, notificationsDiv.firstChild);
    }

    // Initialisation
    updateConnectionStatus(false);
</script>
</body>
</html>